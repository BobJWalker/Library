{
    "Id": "d166457a-1421-4731-b143-dd6766fb95d5",
    "Name": "Calculate Deployment Mode",
    "Description": "This step uses Octopus [System Variables](https://octopus.com/docs/projects/variables/system-variables) to calculate the deployment mode.  The potential modes are:\n\n- **Deploy**: A newer version is being deployed to the target environment.  For example, `2021.1.4` is being deployed to **Production** to replace `2021.0.5`.\n- **Rollback**: An older version is being deployed to the target environment. For example, `2021.0.5` is being deployed to **Production** to replace `2021.1.4`.\n- **Redeploy**: The same version is being deployed to the target environment.  For example, `2021.1.4` is being deployed to **Production** which already has `2021.1.4`.\n\n**Please note**: This step template uses the release numbers to calculate the deployment mode.  It doesn't look at any packages.\n\nAfter calculating the deployment mode, the step template will calculate the version difference.  The potential options are:\n- **Identical**: No differences between the previous release and the current release were found.\n- **Major**: The first number (2021 in 2021.1.2.10) is different between the previous release and the current release.\n- **Minor**: The second number (1 in 2021.1.2.10) is different between the previous release and the current release.\n- **Build**: The third number (2 in 2021.1.2.10) is different between the previous release and the current release.\n- **Revision**: The fourth number (10 in 2021.1.2.10) is different between the previous release and the current release.\n\nThe step template will also determine if the deployment was caused by a trigger or is a manual deployment.  Potential values are `True` (caused by a trigger) or `False` (manual deployment).\n\n**Output variables**:\n\n- **DeploymentMode**: Will either be `Deploy`, `Rollback` or `Redeploy`.\n- **Trigger**: Will either be `True` or `False`.\n- **VersionChange**: Will either be `Identical`, `Major`, `Minor`, `Build`, or `Revision`.\n\n**Run Condition Output Variables**\n\nAll the output variables below can be used in variable run conditions.  They all include the necessary comparison logic as well as logic to not run a step when an error occurs.\n\n- **RunOnDeploy**: Only run the step when the **DeploymentMode** is `Deploy`.\n- **RunOnRollback**: Only run the step when the **DeploymentMode** is `Rollback`.\n- **RunOnRedeploy**: Only run the step when the **DeploymentMode** is `Redeploy`.\n- **RunOnDeployOrRollback**: Only run the step when the **DeploymentMode** is`Deploy` or `Rollback`.\n- **RunOnDeployOrRedeploy**: Only run the step when the **DeploymentMode** is`Deploy` or `Redeploy`.\n- **RunOnRedeployOrRollback**: Only run the step when the **DeploymentMode** is `Redeploy` or `Rollback`.\n- **RunOnMajorVersionChange**: Only run the step when the **VersionChange** is `Major`.\n- **RunOnMinorVersionChange**: Only run the step when the **VersionChange** is `Minor`.\n- **RunOnMajorOrMinorVersionChange**: Only run the step when the **VersionChange** is `Major` or `Minor`.\n- **RunOnBuildVersionChange**: Only run the step when the **VersionChange** is `Build`.\n- **RunOnRevisionVersionChange**: Only run the step when the **VersionChange** is `Revision`.\n\n**Please Note:** This step template is designed for deployment processes only.  Runbooks have no concept of deployments, redeployments, or rollbacks.\n\nThis step was designed to run on a worker (or the Octopus Server).  It can run on targets, but the output variables will all be the same; running on targets will do nothing but waste compute cycles.",
    "ActionType": "Octopus.Script",
    "Version": 1,
    "CommunityActionTemplateId": null,
    "Packages": [],
    "Properties": {
      "Octopus.Action.RunOnServer": "true",
      "Octopus.Action.Script.ScriptSource": "Inline",
      "Octopus.Action.Script.Syntax": "PowerShell",
      "Octopus.Action.Script.ScriptBody": "$currentReleaseNumber = $OctopusParameters[\"Octopus.Release.Number\"]\n$previousReleaseNumber = $OctopusParameters[\"Octopus.Release.CurrentForEnvironment.Number\"]\n$stepName = $OctopusParameters[\"Octopus.Action.StepName\"]\n$triggerName = $OctopusParameters[\"Octopus.Deployment.Trigger.Name\"]\n\nWrite-Host \"The last release to this environment was $previousReleaseNumber\"\nWrite-Host \"The current release number is $currentReleaseNumber\"\n\nif ($previousReleaseNumber -like \"*-*\")\n{\n\t$previousReleaseNumber = $previousReleaseNumber.SubString(0, $previousReleaseNumber.IndexOf(\"-\"))\n}\n\nif ($currentReleaseNumber -like \"*-*\")\n{\n\t$currentReleaseNumber = $currentReleaseNumber.SubString(0, $currentReleaseNumber.IndexOf(\"-\"))\n}\n\nWrite-Host \"The non-pre release tag previous version for the environment was $previousReleaseNumber\"\nWrite-Host \"The non-pre release tag current release number is $currentReleaseNumber\"\n\n$currentVersion = [System.Version]$currentReleaseNumber\n$previousVersion = [System.Version]$previousReleaseNumber\n\n$differentVersions = $false\nif ($currentVersion -eq $previousVersion)\n{\n\tWrite-Highlight \"The current release number $currentReleaseNumber matches the previous release number $previousReleaseNumber, this is a redeployment.\"\n\t$deploymentMode = \"Redeploy\"       \n}\nelseif ($currentVersion -lt $previousVersion)\n{\n\tWrite-Highlight \"The current release number $currentReleaseNumber is less than the previous release number $previousReleaseNumber, this is a rollback.\"\n\t$deploymentMode = \"Rollback\"\n    $differentVersions = $true\n}\nelse\n{\n\tWrite-Highlight \"The current release number $currentReleaseNumber is greater than the previous release number $previousReleaseNumber, this is a deployment.\"\n    $deploymentMode = \"Deploy\"\n    $differentVersions = $true\n}\n\n$differenceKind = \"Identical\"\nif ($differentVersions)\n{\n\tif ($currentVersion.Major -ne $previousVersion.Major)\n    {\n    \tWrite-Highlight \"$currentReleaseNumber is a major version change from $previousReleaseNumber\"\n    \t$differenceKind = \"Major\"\n    }\n    elseif ($currentVersion.Minor -ne $previousVersion.Minor)\n    {\n    \tWrite-Highlight \"$currentReleaseNumber is a minor version change from $previousReleaseNumber\"\n    \t$differenceKind = \"Minor\"\n    }\n    elseif ($currentVersion.Build -ne $previousVersion.Build)\n    {\n    \tWrite-Highlight \"$currentReleaseNumber is a build version change from $previousReleaseNumber\"\n    \t$differenceKind = \"Build\"\n    }\n    elseif ($currentVersion.Revision -ne $previousVersion.Revision)\n    {\n    \tWrite-Highlight \"$currentReleaseNumber is a revision version change from $previousReleaseNumber\"\n    \t$differenceKind = \"Revision\"\n    }\n}\n\n$trigger = $false\nif ([string]::IsNullOrWhiteSpace($triggerName) -eq $false)\n{\n\tWrite-Highlight \"This task was created by trigger $triggerName.\"\n    $trigger = $true\n}\n\nWrite-Highlight \"Setting the output variable 'Octopus.Action[$($stepName)].Output.DeploymentMode' to '$deploymentMode'\"\nSet-OctopusVariable -Name \"DeploymentMode\" -Value $deploymentMode\n\nWrite-Highlight \"Setting the output variable 'Octopus.Action[$($stepName)].Output.VersionChange' to '$differenceKind'\"\nSet-OctopusVariable -Name \"VersionChange\" -Value $differenceKind\n\nWrite-Highlight \"Setting the output variable 'Octopus.Action[$($stepName)].Output.Trigger' to '$trigger'\"\nSet-OctopusVariable -Name \"Trigger\" -Value $trigger\n\nWrite-Highlight \"Setting additional run condition output variables.  Please check task log for their names.\"\n$runOnRollback = \"#{unless Octopus.Deployment.Error}#{if Octopus.Action[$($stepName)].Output.DeploymentMode == \"\"Rollback\"\"}True#{else}False#{/if}#{/unless}\"\nWrite-Host \"Setting the output variable 'Octopus.Action[$($stepName)].Output.RunOnRollback' so you can use it as a run condition\"\nWrite-Verbose $runOnRollback\nSet-OctopusVariable -Name \"RunOnRollback\" -Value $runOnRollback\n\n$runOnDeploy = \"#{unless Octopus.Deployment.Error}#{if Octopus.Action[$($stepName)].Output.DeploymentMode == \"\"Deploy\"\"}True#{else}False#{/if}#{/unless}\"\nWrite-Host \"Setting the output variable 'Octopus.Action[$($stepName)].Output.RunOnDeploy' so you can use it as a run condition\"\nWrite-Verbose $runOnDeploy\nSet-OctopusVariable -Name \"RunOnDeploy\" -Value $runOnDeploy\n\n$runOnRedeploy = \"#{unless Octopus.Deployment.Error}#{if Octopus.Action[$($stepName)].Output.DeploymentMode == \"\"Redeploy\"\"}True#{else}False#{/if}#{/unless}\"\nWrite-Host \"Setting the output variable 'Octopus.Action[$($stepName)].Output.RunOnRedeploy' so you can use it as a run condition\"\nWrite-Verbose $runOnRedeploy\nSet-OctopusVariable -Name \"RunOnRedeploy\" -Value $runOnRedeploy\n\n$runOnDeployOrRollback = \"#{unless Octopus.Deployment.Error}#{if Octopus.Action[$($stepName)].Output.DeploymentMode != \"\"Redeploy\"\"}True#{else}False#{/if}#{/unless}\"\nWrite-Host \"Setting the output variable 'Octopus.Action[$($stepName)].Output.RunOnDeployOrRollback' so you can use it as a run condition\"\nWrite-Verbose $runOnDeployOrRollback\nSet-OctopusVariable -Name \"RunOnDeployOrRollback\" -Value $runOnDeployOrRollback\n\n$runOnDeployOrRedeploy = \"#{unless Octopus.Deployment.Error}#{if Octopus.Action[$($stepName)].Output.DeploymentMode != \"\"Rollback\"\"}True#{else}False#{/if}#{/unless}\"\nWrite-Host \"Setting the output variable 'Octopus.Action[$($stepName)].Output.RunOnDeployOrRedeploy' so you can use it as a run condition\"\nWrite-Verbose $runOnDeployOrRedeploy\nSet-OctopusVariable -Name \"RunOnDeployOrRedeploy\" -Value $runOnDeployOrRedeploy\n\n$runOnRedeployOrRollback = \"#{unless Octopus.Deployment.Error}#{if Octopus.Action[$($stepName)].Output.DeploymentMode != \"\"Deploy\"\"}True#{else}False#{/if}#{/unless}\"\nWrite-Host \"Setting the output variable 'Octopus.Action[$($stepName)].Output.RunOnRedeployOrRollback' so you can use it as a run condition\"\nWrite-Verbose $runOnRedeployOrRollback\nSet-OctopusVariable -Name \"RunOnRedeployOrRollback\" -Value $runOnRedeployOrRollback\n\n$runOnMajorVersionChange = \"#{unless Octopus.Deployment.Error}#{if Octopus.Action[$($stepName)].Output.VersionChange == \"\"Major\"\"}True#{else}False#{/if}#{/unless}\"\nWrite-Host \"Setting the output variable 'Octopus.Action[$($stepName)].Output.RunOnMajorVersionChange' so you can use it as a run condition\"\nWrite-Verbose $runOnMajorVersionChange\nSet-OctopusVariable -Name \"RunOnMajorVersionChange\" -Value $runOnMajorVersionChange\n\n$runOnMinorVersionChange = \"#{unless Octopus.Deployment.Error}#{if Octopus.Action[$($stepName)].Output.VersionChange == \"\"Minor\"\"}True#{else}False#{/if}#{/unless}\"\nWrite-Host \"Setting the output variable 'Octopus.Action[$($stepName)].Output.RunOnMinorVersionChange' so you can use it as a run condition\"\nWrite-Verbose $runOnMinorVersionChange\nSet-OctopusVariable -Name \"RunOnMinorVersionChange\" -Value $runOnMinorVersionChange\n\n$runOnMajorOrMinorVersionChange = \"#{unless Octopus.Deployment.Error}#{if Octopus.Action[$stepName].Output.VersionChange == \"\"Major\"\"}True#{else}#{if Octopus.Action[$stepName].Output.VersionChange == \"\"Minor\"\"}True#{else}False#{/if}#{/if}#{/unless}\"\nWrite-Host \"Setting the output variable 'Octopus.Action[$($stepName)].Output.RunOnMajorOrMinorVersionChange' so you can use it as a run condition\"\nWrite-Verbose $runOnMajorOrMinorVersionChange\nSet-OctopusVariable -Name \"RunOnMajorOrMinorVersionChange\" -Value $runOnMajorOrMinorVersionChange\n\n$runOnBuildVersionChange = \"#{unless Octopus.Deployment.Error}#{if Octopus.Action[$($stepName)].Output.VersionChange == \"\"Build\"\"}True#{else}False#{/if}#{/unless}\"\nWrite-Host \"Setting the output variable 'Octopus.Action[$($stepName)].Output.RunOnBuildVersionChange' so you can use it as a run condition\"\nWrite-Verbose $runOnBuildVersionChange\nSet-OctopusVariable -Name \"RunOnBuildVersionChange\" -Value $runOnBuildVersionChange\n\n$runOnRevisionVersionChange = \"#{unless Octopus.Deployment.Error}#{if Octopus.Action[$($stepName)].Output.VersionChange == \"\"Revision\"\"}True#{else}False#{/if}#{/unless}\"\nWrite-Host \"Setting the output variable 'Octopus.Action[$($stepName)].Output.RunOnRevisionVersionChange' so you can use it as a run condition\"\nWrite-Verbose $runOnRevisionVersionChange\nSet-OctopusVariable -Name \"RunOnRevisionVersionChange\" -Value $runOnRevisionVersionChange\n"
    },
    "Parameters": [],
    "$Meta": {
      "ExportedAt": "2021-09-10T13:48:09.120Z",
      "OctopusVersion": "2021.1.7738",
      "Type": "ActionTemplate"
    },
    "LastModifiedBy": "BobJWalker",
    "Category": "octopus"
  }